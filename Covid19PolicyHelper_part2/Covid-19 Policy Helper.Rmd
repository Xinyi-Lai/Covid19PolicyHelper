---
title: "Covid-19 Policy Helper"
date: Aug 2020
author: "Xinyi Lai, Yulin Li"
output: 
  html_document: 
    theme: readable
    toc: yes
    toc_depth: 4
    number_sections: no
urlcolor: cyan
editor_options: 
  chunk_output_type: inline
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80)
library(knitr)
opts_chunk$set(cache = TRUE, autodep = TRUE)
```


## Data Preprocessing

### County-Level Demographic Data
```{r message=FALSE}
library(readr)
county_data_abridged = read_csv("county_data_abridged.csv")
```

```{r}
dim(county_data_abridged)
names(county_data_abridged)
```



```{r}
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "#EligibleforMedicare2018"] = "EligibleforMedicare2018"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "#FTEHospitalTotal2017"] = "FTEHospitalTotal2017"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "#HospParticipatinginNetwork2017"] = "HospParticipatinginNetwork2017"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "#Hospitals"] = "Hospitals"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "#ICU_beds"] = "ICU_beds"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "PopulationEstimate65+2017"] = "PopulationEstimate_above65_2017"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "stay at home"] = "stay_at_home"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == ">50 gatherings"] = "above_50_gatherings"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == ">500 gatherings"] = "above_500_gatherings"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "public schools"] = "public_schools"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "restaurant dine-in"] = "restaurant_dine_in"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "entertainment/gym"] = "entertainment_gym"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "federal guidelines"] = "federal_guidelines"
colnames(county_data_abridged)[colnames(county_data_abridged) 
                               == "foreign travel ban"] = "foreign_travel_ban"
```


```{r}
data = subset(county_data_abridged,
              select = c(State, CountyName, POP_LATITUDE, POP_LONGITUDE,
                         PopulationEstimate2018, PopTotalMale2017, 
                         PopulationEstimate_above65_2017, PopulationDensityperSqMile2010, 
                         DiabetesPercentage, Smokers_Percentage, 
                         HeartDiseaseMortality, StrokeMortality, 
                         Hospitals, ICU_beds, HospParticipatinginNetwork2017, 
                         stay_at_home, above_50_gatherings, above_500_gatherings, 
                         restaurant_dine_in, entertainment_gym))
data = na.omit(data)
data = droplevels(data)

data$stay_at_home = data$stay_at_home - range(data$stay_at_home)[1]
data$above_50_gatherings = data$above_50_gatherings - range(data$above_50_gatherings)[1]
data$above_500_gatherings = data$above_500_gatherings - range(data$above_500_gatherings)[1]
data$restaurant_dine_in = data$restaurant_dine_in - range(data$restaurant_dine_in)[1]
data$entertainment_gym = data$entertainment_gym - range(data$entertainment_gym)[1]

str(data)
```

```{r}
data_demographic = data
```


### County-Level Mobility Data

```{r}

```

### County-Level Infection Data 

#### Cases 
```{r message=FALSE, warning=FALSE}
timeseries = read_csv("../datasets/timeseries.csv")
```

```{r}
data = timeseries
data = subset(data, country == "United States" & level == "state")
data = subset(data, !(name %in% c("Unassigned cases, Arkansas, US", 
              "Unassigned cases, Georgia, US", "Unassigned cases, Illinois, US",
              "Unassigned cases, Iowa, US", "Unassigned cases, Maine, US",
              "Unassigned cases, Massachusetts, US", "Unassigned cases, North Dakota, US",
              "Washington, D.C., US")))
data$state = matrix(unlist(strsplit(as.character(data$name), ", ")), ncol = 2, byrow = TRUE)[, 1]
data = subset(data,
              select = c(state, date, cases, deaths, recovered))


StateOfInterest = c("Arizona", "California", "Minnesota", "New Mexico", "New York", 
                   "Oklahoma", "South Carolina", "Tennessee", "Utah", "Virginia", 
                   "West Virginia", "Wisconsin")
data = subset(data, state %in% StateOfInterest)

data$state =     as.factor(data$state)
data$cases =     as.numeric(data$cases)
data$deaths =    as.numeric(data$deaths)
data$recovered = as.numeric(data$recovered)

data = na.omit(data)
data = droplevels(data)

str(data)
```

```{r}
range(data$cases)
range(data$deaths)
range(data$recovered)
```

```{r}
data_cases = data
```


#### SEIR Model Parameters
```{r message=FALSE, warning=FALSE}
model_out = read_csv("../datasets/model_out.csv")
```

```{r}
str(model_out)
```

```{r}
data_parm = model_out
```

### Combined Data of Intersts

```{r}
data = data.frame()
```


## Modeling

```{r}
model_fit_out = data.frame(0)
```

## Testing

```{r}
write.csv(model_fit_out, file = "model_fit_out.csv")
```


## Project Intro

### Draft and Outline
	
1. What we have achieved is a simple, interpretable, accessible model that anyone can get their hands on. It not only works towards assisting the prediction and prevention of pandemic, but also gives us clues on the relationship between variable social factors and the vulnerability of one place to the virus. 

2. This is our very first step to make our own contribution to the control of the pandemic. We believe that everyone can take a step to do their parts, and we need not be freaked out by the technological obstacles and the already-done achievements by the "professionals".

3. My partner and I are both undergraduates in non-CS majors, and this is our first time touching AWS or any other cloud service system. We started everything offline, accomplishing every tasks locally, and it did take us a while to figure out where to incorporate all those into AWS. But soon we see the enriched potentials and capability of AWS. Due to the limited time, we only took a slight bite of the AWS system, but we will be working to dig deeper. 

4. The next step to take is to integrate everything into an efficient cloud computing system so that larger data and more sophisticated models could be handled, especially in a well-automated manner.  

5. There are interested stuffs like the political factor. We may wanna see how it affects 
We have learned a lot from this experience and we are looking forwards to becoming professional data analytistâ€¦blabla


## Appendix 

### Helper Functions 

```{r helper_functions, eval=FALSE}
get_bp_decision = function(model, alpha) {
  decide = unname(bptest(model)$p.value < alpha)
  ifelse(decide, "Reject", "Fail to Reject")
}

get_bp_pval = function(model) {
  bptest(model)$p.value
}

get_sw_decision = function(model, alpha) {
  decide = unname(shapiro.test(resid(model))$p.value < alpha)
  ifelse(decide, "Reject", "Fail to Reject")
}

get_sw_pval = function(model) {
  shapiro.test(resid(model))$p.value
}

get_num_params = function(model) {
  length(coef(model))
}

get_loocv_rmse = function(model, is_log) {
  ifelse(
    is_log, 
    sqrt(mean(na.omit(((dat_trn$price - exp(fitted(model))) / (1 - hatvalues(model))) ^ 2))),
    sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
  )
}

get_adj_r2 = function(model) {
  summary(model)$adj.r.squared
}

test_mod = function(model, is_log = FALSE){
  c(loocv_rmse = get_loocv_rmse(model, is_log), 
    adj_r2 = get_adj_r2(model), 
    bp_pval = get_bp_pval(model), 
    sw_pval = get_sw_pval(model), 
    num_params = get_num_params(model))
}

diagnostics = function(model, pcol = "grey", lcol = "dodgerblue", alpha = 0.05, plotit = TRUE, testit = TRUE){
  if (plotit){
    par(mfrow = c(1, 2), pty="s")
    
    plot(fitted(model), resid(model), col = "grey", pch = 20, 
         xlab = "Fitted", ylab = "Residual", 
         main = "Fitted versus Residuals")
    abline(h = 0, col = "darkorange", lwd = 2)
    
    qqnorm(resid(model), col = pcol)
    qqline(resid(model), col = lcol, lwd = 2)
  }
  if (testit){
    list(p_val = shapiro.test(resid(model))$p, 
         decision = ifelse(test = shapiro.test(resid(model))$p < alpha, 
                           yes = "Reject", no = "Fail to Reject"))
  }
}

get_test_rmse = function(model) {
  sqrt(mean((dat_tst$price - predict(model, newdata = dat_tst))^ 2))
}

get_perc_err = function(model) {
  actual = dat_tst$price
  predicted = predict(model, dat_tst)
  100 * mean((abs(actual - predicted)) / actual)
}
```
